{
    "name": "AgentTesla.yar",
    "rule": "rule agent_tesla\n{\n    meta:\n        description = \"Detecting HTML strings used by Agent Tesla malware\"\n        author = \"Stormshield\"\n        version = \"1.0\"\n\n    strings:\n        $html_username    = \"<br>UserName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: \" wide ascii\n        $html_pc_name     = \"<br>PC&nbsp;Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: \" wide ascii\n        $html_os_name     = \"<br>OS&nbsp;Full&nbsp;Name&nbsp;&nbsp;: \" wide ascii\n        $html_os_platform = \"<br>OS&nbsp;Platform&nbsp;&nbsp;&nbsp;: \" wide ascii\n        $html_clipboard   = \"<br><span style=font-style:normal;text-decoration:none;text-transform:none;color:#FF0000;><strong>[clipboard]</strong></span>\" wide ascii\n\n    condition:\n        3 of them\n}\n\nrule AgentTesla\n{\n    meta:\n        author = \"kevoreilly\"\n        description = \"AgentTesla Payload\"\n        cape_type = \"AgentTesla Payload\"\n    strings:\n        $string1 = \"smtp\" wide\n        $string2 = \"appdata\" wide\n        $string3 = \"76487-337-8429955-22614\" wide\n        $string4 = \"yyyy-MM-dd HH:mm:ss\" wide\n        //$string5 = \"%site_username%\" wide\n        $string6 = \"webpanel\" wide\n        $string7 = \"<br>UserName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:\" wide\n        $string8 = \"<br>IP Address&nbsp;&nbsp;:\" wide\n\n        $agt1 = \"IELibrary.dll\" ascii\n        $agt2 = \"C:\\\\Users\\\\Admin\\\\Desktop\\\\IELibrary\\\\IELibrary\\\\obj\\\\Debug\\\\IELibrary.pdb\" ascii\n        $agt3 = \"GetSavedPasswords\" ascii\n        $agt4 = \"GetSavedCookies\" ascii\n    condition:\n        uint16(0) == 0x5A4D and (all of ($string*) or 3 of ($agt*))\n}\n\nrule AgentTeslaV2 {\n    meta:\n        author = \"ditekshen\"\n        description = \"AgenetTesla Type 2 Keylogger payload\"\n        cape_type = \"AgentTesla Payload\"\n    strings:\n        $s1 = \"get_kbHook\" ascii\n        $s2 = \"GetPrivateProfileString\" ascii\n        $s3 = \"get_OSFullName\" ascii\n        $s4 = \"get_PasswordHash\" ascii\n        $s5 = \"remove_Key\" ascii\n        $s6 = \"FtpWebRequest\" ascii\n        $s7 = \"logins\" fullword wide\n        $s8 = \"keylog\" fullword wide\n        $s9 = \"1.85 (Hash, version 2, native byte-order)\" wide\n\n        $cl1 = \"Postbox\" fullword ascii\n        $cl2 = \"BlackHawk\" fullword ascii\n        $cl3 = \"WaterFox\" fullword ascii\n        $cl4 = \"CyberFox\" fullword ascii\n        $cl5 = \"IceDragon\" fullword ascii\n        $cl6 = \"Thunderbird\" fullword ascii\n    condition:\n        (uint16(0) == 0x5a4d and 6 of ($s*)) or (6 of ($s*) and 2 of ($cl*))\n}\n\nrule AgentTeslaV3 {\n    meta:\n      author = \"ditekshen\"\n      description = \"AgentTeslaV3 infostealer payload\"\n      cape_type = \"AgentTesla payload\"\n    strings:\n        $s1 = \"get_kbok\" fullword ascii\n        $s2 = \"get_CHoo\" fullword ascii\n        $s3 = \"set_passwordIsSet\" fullword ascii\n        $s4 = \"get_enableLog\" fullword ascii\n        $s5 = \"bot%telegramapi%\" wide\n        $s6 = \"KillTorProcess\" fullword ascii\n        $s7 = \"GetMozilla\" ascii\n        $s8 = \"torbrowser\" wide\n        $s9 = \"%chatid%\" wide\n        $s10 = \"logins\" fullword wide\n        $s11 = \"credential\" fullword wide\n        $s12 = \"AccountConfiguration+\" wide\n        $s13 = \"<a.+?href\\\\s*=\\\\s*([\\\"'])(?<href>.+?)\\\\1[^>]*>\" fullword wide\n        $s14 = \"set_Lenght\" fullword ascii\n        $s15 = \"get_Keys\" fullword ascii\n        $s16 = \"set_AllowAutoRedirect\" fullword ascii\n        $s17 = \"set_wtqQe\" fullword ascii\n        $s18 = \"set_UseShellExecute\" fullword ascii\n        $s19 = \"set_IsBodyHtml\" fullword ascii\n        $s20 = \"set_FElvMn\" fullword ascii\n        $s21 = \"set_RedirectStandardOutput\" fullword ascii\n\n        $g1 = \"get_Clipboard\" fullword ascii\n        $g2 = \"get_Keyboard\" fullword ascii\n        $g3 = \"get_Password\" fullword ascii\n        $g4 = \"get_CtrlKeyDown\" fullword ascii\n        $g5 = \"get_ShiftKeyDown\" fullword ascii\n        $g6 = \"get_AltKeyDown\" fullword ascii\n\n        $m1 = \"yyyy-MM-dd hh-mm-ssCookieapplication/zipSCSC_.jpegScreenshotimage/jpeg/log.tmpKLKL_.html<html></html>Logtext/html[]Time\" ascii\n        $m2 = \"%image/jpg:Zone.Identifier\\\\tmpG.tmp%urlkey%-f \\\\Data\\\\Tor\\\\torrcp=%PostURL%127.0.0.1POST+%2B\" ascii\n        $m3 = \">{CTRL}</font>Windows RDPcredentialpolicyblobrdgchrome{{{0}}}CopyToComputeHashsha512CopySystemDrive\\\\WScript.ShellRegReadg401\" ascii\n        $m4 = \"%startupfolder%\\\\%insfolder%\\\\%insname%/\\\\%insfolder%\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run%insregname%SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\StartupApproved\\\\RunTruehttp\" ascii\n        $m5 = \"\\\\WindowsLoad%ftphost%/%ftpuser%%ftppassword%STORLengthWriteCloseGetBytesOpera\" ascii\n    condition:\n        (uint16(0) == 0x5a4d and (8 of ($s*) or (6 of ($s*) and 4 of ($g*)))) or (2 of ($m*))\n}\n\nrule AgentTeslaV4\n{\n    meta:\n        author = \"kevoreilly\"\n        description = \"AgentTesla Payload\"\n        cape_type = \"AgentTesla Payload\"\n        packed = \"7f8a95173e17256698324886bb138b7936b9e8c5b9ab8fffbfe01080f02f286c\"\n    strings:\n        $decode1 = {(07|FE 0C 01 00) (07|FE 0C 01 00) 8E 69 (17|20 01 00 00 00) 63 8F ?? 00 00 01 25 47 (06|FE 0C 00 00) (1A|20 04 00 00 00) 58 4A D2 61 D2 52}\n        $decode2 = {(07|FE 0C 01 00) (08|FE 0C 02 00) 8F ?? 00 00 01 25 47 (07|FE 0C 01 00) (11 07|FE 0C 07 00) 91 (06|FE 0C 00 00) (1A|20 04 00 00 00) 58 4A 61 D2 61 D2 52}\n        $decode3 = {(07|FE 0C 01 00) (11 07|FE 0C 07 00) 8F ?? 00 00 01 25 47 (07|FE 0C 01 00) (08|FE 0C 02 00) 91 61 D2 52}\n    condition:\n        uint16(0) == 0x5A4D and all of them\n}\n\nrule AgentTeslaV4JIT\n{\n    meta:\n        author = \"kevoreilly\"\n        description = \"AgentTesla JIT-compiled native code\"\n        cape_type = \"AgentTesla Payload\"\n        packed = \"7f8a95173e17256698324886bb138b7936b9e8c5b9ab8fffbfe01080f02f286c\"\n    strings:\n        $decode1 = {8B 01 8B 40 3C FF 50 10 8B C8 E8 [4] 89 45 CC B8 1A 00 00 00}\n        $decode2 = {83 F8 18 75 2? 8B [2-5] D1 F8}\n        $decode3 = {8D 4C 0? 08 0F B6 01 [0-3] 0F B6 5? 04 33 C2 88 01 B8 19 00 00 00}\n    condition:\n        2 of them\n}\n\nrule AgentTeslaV5 {\n    meta:\n      author = \"ClaudioWayne\"\n      description = \"AgentTeslaV5 infostealer payload\"\n      cape_type = \"AgentTesla payload\"\n      sample = \"893f4dc8f8a1dcee05a0840988cf90bc93c1cda5b414f35a6adb5e9f40678ce9\"\n    strings:\n        $template1 = \"<br>User Name: \" fullword wide\n        $template2 = \"<br>Username: \" fullword wide\n        $template3 = \"<br>RAM: \" fullword wide\n        $template4 = \"<br>Password: \" fullword wide\n        $template5 = \"<br>OSFullName: \" fullword wide\n        $template6 = \"<br><hr>Copied Text: <br>\" fullword wide\n        $template7 = \"<br>CPU: \" fullword wide\n        $template8 = \"<br>Computer Name: \" fullword wide\n        $template9 = \"<br>Application: \" fullword wide\n\n        $chromium_browser1 = \"Comodo\\\\Dragon\\\\User Data\" fullword wide\n        $chromium_browser2 = \"Fenrir Inc\\\\Sleipnir5\\\\setting\\\\modules\\\\ChromiumViewer\" fullword wide\n        $chromium_browser3 = \"Google\\\\Chrome\\\\User Data\" fullword wide\n        $chromium_browser4 = \"Elements Browser\\\\User Data\" fullword wide\n        $chromium_browser5 = \"Yandex\\\\YandexBrowser\\\\User Data\" fullword wide\n        $chromium_browser6 = \"MapleStudio\\\\ChromePlus\\\\User Data\" fullword wide\n\n        $mozilla_browser1 = \"\\\\Mozilla\\\\SeaMonkey\\\\\" fullword wide\n        $mozilla_browser2 = \"\\\\K-Meleon\\\\\" fullword wide\n        $mozilla_browser3 = \"\\\\NETGATE Technologies\\\\BlackHawk\\\\\" fullword wide\n        $mozilla_browser4 = \"\\\\Thunderbird\\\\\" fullword wide\n        $mozilla_browser5 = \"\\\\8pecxstudios\\\\Cyberfox\\\\\" fullword wide\n        $mozilla_browser6 = \"360Chrome\\\\Chrome\\\\User Data\" fullword wide\n        $mozilla_browser7 = \"\\\\Mozilla\\\\Firefox\\\\\" fullword wide\n\n        $database1 = \"Berkelet DB\" fullword wide\n        $database2 = \" 1.85 (Hash, version 2, native byte-order)\" fullword wide\n        $database3 = \"00061561\" fullword wide\n        $database4 = \"key4.db\" fullword wide\n        $database5 = \"key3.db\" fullword wide\n        $database6 = \"global-salt\" fullword wide\n        $database7 = \"password-check\" fullword wide\n\n        $software1 = \"\\\\FileZilla\\\\recentservers.xml\" fullword wide\n        $software2 = \"\\\\VirtualStore\\\\Program Files (x86)\\\\FTP Commander\\\\Ftplist.txt\" fullword wide\n        $software3 = \"\\\\The Bat!\" fullword wide\n        $software4 = \"\\\\Apple Computer\\\\Preferences\\\\keychain.plist\" fullword wide\n        $software5 = \"\\\\MySQL\\\\Workbench\\\\workbench_user_data.dat\" fullword wide\n        $software6 = \"\\\\Trillian\\\\users\\\\global\\\\accounts.dat\" fullword wide\n        $software7 = \"SOFTWARE\\\\Martin Prikryl\\\\WinSCP 2\\\\Sessions\" fullword wide\n        $software8 = \"FTP Navigator\\\\Ftplist.txt\" fullword wide\n        $software9 = \"NordVPN\" fullword wide\n        $software10 = \"JDownloader 2.0\\\\cfg\" fullword wide\n    condition:\n        uint16(0) == 0x5a4d and 4 of ($template*) and 3 of ($chromium_browser*) and 3 of ($mozilla_browser*) and 3 of ($database*) and 5 of ($software*)\n}\n",
    "uploadedBy": "f0b33c9c-0019-4046-984b-f6f3d95dea61",
    "category": "yar",
    "uploadedAt": "2025-05-07T09:54:43.659Z",
    "status": "active"
}