{
    "name": "OneNote.yar",
    "rule": "/*\n   YARA Rule Set for OneNote Files  \n*/\n\nrule Microsoft_OneNote_with_Suspicious_String\n{\n    meta:\n        author         = \"InQuest Labs\"\n        description    = \"This signature detects Microsoft OneNote files containing suspicious strings.\"\n        created_date   = \"2023-02-24\"\n        updated_date   = \"2023-02-24\"\n        blog_reference = \"https://inquest.net/blog/2023/02/27/youve-got-malware-rise-threat-actors-using-microsoft-onenote-malicious-campaigns\"\n        labs_reference = \"N/A\"\n        labs_pivot     = \"N/A\"\n        samples        = \"660870c3f3e8ff105e5cc06b3b3d04436118fc67533c93d0df56bde359e335d0\"\n\n    strings:\n        $suspicious_00 = \"<script\" nocase ascii wide\n        $suspicious_01 = \"cmd.exe\" nocase ascii wide\n        $suspicious_02 = \"CreateObject\" nocase ascii wide\n        $suspicious_03 = \"CreateProcess\" nocase ascii wide\n        $suspicious_04 = \"echo off\" nocase ascii wide\n        $suspicious_05 = \"ExecuteCmdAsync\" nocase ascii wide\n        $suspicious_06 = \"mshta\" nocase ascii wide\n        $suspicious_07 = \"msiexec\" nocase ascii wide\n        $suspicious_08 = \"powershell\" nocase ascii wide\n        $suspicious_09 = \"regsvr32\" nocase ascii wide\n        $suspicious_10 = \"rundll32\" nocase ascii wide\n        $suspicious_11 = \"schtasks\" nocase ascii wide\n        $suspicious_12 = \"SetEnvironmentVariable\" nocase ascii wide\n        $suspicious_13 = \"winmgmts\" nocase ascii wide\n        $suspicious_14 = \"Wscript\" nocase ascii wide\n        $suspicious_15 = \"WshShell\" nocase ascii wide\n    condition:\n        uint32be(0) == 0xE4525C7B and any of ($suspicious*)\n}\n\nrule SUSP_Email_Suspicious_OneNote_Attachment_Jan23_1 {\n   meta:\n      description = \"Detects suspicious OneNote attachment that embeds suspicious payload, e.g. an executable (FPs possible if the PE is attached separately)\"\n      author = \"Florian Roth (Nextron Systems)\"\n      reference = \"Internal Research\"\n      date = \"2023-01-27\"\n      score = 65\n   strings:\n      /* OneNote FileDataStoreObject GUID https://blog.didierstevens.com/ */\n      $ge1 = \"5xbjvWUmEUWkxI1NC3qer\"\n      $ge2 = \"cW471lJhFFpMSNTQt6nq\"\n      $ge3 = \"nFuO9ZSYRRaTEjU0Lep6s\"\n      /* PE file DOS header */\n      $sp1 = \"VGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1vZG\"\n      $sp2 = \"RoaXMgcHJvZ3JhbSBjYW5ub3QgYmUgcnVuIGluIERPUyBtb2Rl\"\n      $sp3 = \"UaGlzIHByb2dyYW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZ\"\n      $sp4 = \"VGhpcyBwcm9ncmFtIG11c3QgYmUgcnVuIHVuZGVy\"\n      $sp5 = \"RoaXMgcHJvZ3JhbSBtdXN0IGJlIHJ1biB1bmRlc\"\n      $sp6 = \"UaGlzIHByb2dyYW0gbXVzdCBiZSBydW4gdW5kZX\"\n      /* @echo off */\n      $se1 = \"QGVjaG8gb2Zm\"\n      $se2 = \"BlY2hvIG9mZ\"\n      $se3 = \"AZWNobyBvZm\"\n      /* <HTA:APPLICATION */\n      $se4 = \"PEhUQTpBUFBMSUNBVElPTi\"\n      $se5 = \"xIVEE6QVBQTElDQVRJT04g\"\n      $se6 = \"8SFRBOkFQUExJQ0FUSU9OI\"\n      /* LNK file magic header */\n      $se7 = \"TAAAAAEUAg\"\n      $se8 = \"wAAAABFAIA\"\n      $se9 = \"MAAAAARQCA\"\n   condition:\n      filesize < 5MB\n      and 1 of ($ge*)\n      and 1 of ($s*)\n}\n\nrule SUSP_Email_Suspicious_OneNote_Attachment_Jan23_2 {\n   meta:\n      description = \"Detects suspicious OneNote attachment that has a file name often used in phishing attacks\"\n      author = \"Florian Roth (Nextron Systems)\"\n      reference = \"Internal Research\"\n      date = \"2023-01-27\"\n      score = 65\n   strings:\n      /* .one\\n\\n5FJce */\n      $hc1 = { 2E 6F 6E 65 22 0D 0A 0D 0A 35 46 4A 63 65 }\n      $x01 = \" attachment; filename=\\\"Invoice\" nocase\n      $x02 = \" attachment; filename=\\\"ORDER\" nocase\n      $x03 = \" attachment; filename=\\\"PURCHASE\" nocase\n      $x04 = \" attachment; filename=\\\"SHIP\" nocase\n   condition:\n      filesize < 5MB \n      and $hc1 \n      and 1 of ($x*)\n}\n\nrule SUSP_OneNote_Embedded_FileDataStoreObject_Type_Jan23_1 {\n   meta:\n      description = \"Detects suspicious embedded file types in OneNote files\"\n      author = \"Florian Roth\"\n      reference = \"https://blog.didierstevens.com/\"\n      date = \"2023-01-27\"\n      modified = \"2023-02-27\"\n      score = 65\n   strings:\n      /* GUID FileDataStoreObject https://blog.didierstevens.com/ */\n      $x1 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac \n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? 4d 5a } // PE\n      $x2 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac \n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [0-4] 40 65 63 68 6f } // @echo off\n      $x3 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac \n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [0-4] 40 45 43 48 4f } // @ECHO OFF\n      $x4 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac \n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [0-4] 4F 6E 20 45 } // On Error Resume\n      $x5 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac \n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [0-4] 6F 6E 20 65 } // on error resume\n      $x6 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac\n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? 4c 00 00 00 } // LNK file\n      $x7 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac\n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? 49 54 53 46 } // CHM file\n      $x8 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac\n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [6-200] 3C 68 74 61 3A } // hta:\n      $x9 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac\n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [6-200] 3C 48 54 41 3A } // HTA:\n      $x10 = { e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac\n              ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??\n              ?? ?? ?? ?? [6-200] 3C 6A 6F 62 20 } // WSF file \"<job \"\n   condition:\n      filesize < 10MB and 1 of them\n}\n\nrule SUSP_OneNote_Embedded_FileDataStoreObject_Type_Jan23_2 {\n   meta:\n      description = \"Detects suspicious embedded file types in OneNote files\"\n      author = \"Florian Roth (Nextron Systems)\"\n      reference = \"https://blog.didierstevens.com/\"\n      date = \"2023-01-27\"\n      score = 65\n   strings:\n      /* GUID FileDataStoreObject https://blog.didierstevens.com/ */\n      $a1 = { 00 e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac }\n      $s1 = \"<HTA:APPLICATION \"\n   condition:\n      filesize < 5MB\n      and $a1 \n      and 1 of ($s*)\n}   \n\nrule SUSP_OneNote_Win_Script_Encoding_Feb23 {\n   meta:\n      description = \"Presence of Windows Script Encoding Header in a OneNote file with embedded files\"\n      author = \"delivr.to\"\n      date = \"2023-02-19\"\n      score = 60\n   strings:\n      /* [MS-ONESTORE] File Header */\n      $one = { E4 52 5C 7B 8C D8 A7 4D AE B1 53 78 D0 29 96 D3 }\n      /* FileDataStoreObject GUID */\n      $fdso = { 00 e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac }\n      /* Windows Script Encoding Header */\n      $wse = { 23 40 7E 5E }\n   condition:\n      filesize < 5MB and\n      ($one at 0) and \n      $fdso and\n      $wse\n}\n\nrule SUSP_OneNote_Repeated_FileDataReference_Feb23 {\n   meta:\n      description = \"Repeated references to files embedded in OneNote file. May indicate multiple copies of file hidden under image, as leveraged by Qakbot et al.\"\n      author = \"delivr.to\"\n      date = \"2023-02-17\"\n      score = 60\n   strings:\n      /* [MS-ONESTORE] File Header */\n      $one = { E4 52 5C 7B 8C D8 A7 4D AE B1 53 78 D0 29 96 D3 }\n      /* FileDataStoreObject GUID */\n      $fdso = { 00 e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac }\n      /* FileDataReference <ifndf>{GUID} */\n      /* https://interoperability.blob.core.windows.net/files/MS-ONESTORE/%5bMS-ONESTORE%5d.pdf */\n      $fref = { 3C 00 69 00 66 00 6E 00 64 00 66 00 3E 00 7B 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 2D 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 2D 00 ?? 00 ?? 00 ?? 00 ?? 00 2D 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? 00 ?? }\n   condition:\n      filesize < 5MB and\n      ($one at 0) and \n      $fdso and\n      #fref > (#fdso * 4)\n}\n\nrule SUSP_OneNote_RTLO_Character_Feb23 {\n   meta:\n      description = \"Presence of RTLO Unicode Character in a OneNote file with embedded files\"\n      author = \"delivr.to\"\n      date = \"2023-02-17\"\n      score = 60\n   strings:\n      /* [MS-ONESTORE] File Header */\n      $one = { E4 52 5C 7B 8C D8 A7 4D AE B1 53 78 D0 29 96 D3 }\n      /* FileDataStoreObject GUID */\n      $fdso = { 00 e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac }\n      /* RTLO */\n      $rtlo = { 00 2E 20 }\n   condition:\n      filesize < 5MB and\n      ($one at 0) and \n      $fdso and\n      $rtlo\n}\n\nrule OneNote_EmbeddedFiles_NoPictures\n{\n    meta:\n        author = \"Nicholas Dhaeyer - @DhaeyerWolf\"\n        date_created = \"2023-02-14 - <3\"\n        date_last_modified = \"2023-02-17\"\n        description = \"OneNote files that contain embedded files that are not pictures.\"\n        reference = \"https://blog.didierstevens.com/2023/01/22/analyzing-malicious-onenote-documents/\"\n\t\tyarahub_uuid = \"d0c4f0e6-adbe-4953-a2df-91427a561e97\"\n\t\tdate = \"2023-02-14\"\n\t\tyarahub_license = \"CC0 1.0\"\n\t\tyarahub_rule_matching_tlp = \"TLP:WHITE\"\n\t\tyarahub_rule_sharing_tlp = \"TLP:WHITE\"\n\t\tyarahub_reference_md5 = \"52486a446dd4fc5842a47b57d3febec7\"\n\n    strings:\n\t\t$start = { e4 52 5c 7b 8c d8 a7 4d ae b1 53 78 d0 29 96 d3 } //beginning of a OneNote file\n\t\n        $EmbeddedFileGUID =  { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC }\n        $PNG = { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 89 50 4E 47 0D 0A 1A 0A }\n        $JPG = { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 FF D8 FF }\n        $JPG20001 = { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0C 6A 50 20 20 0D 0A 87 0A }\n        $JPG20002 = { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 FF 4F FF 51 }\n        $BMP = { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 42 4D }\n        $GIF = { E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 47 49 46 }\n    condition:\n        $start at 0 and $EmbeddedFileGUID and (#EmbeddedFileGUID > #PNG + #JPG + #JPG20001 + #JPG20002 + #BMP + #GIF)\n}\n\nrule OneNote_Malicious_Paths\n{\n\tmeta:\n        author = \"Nicholas Dhaeyer - @DhaeyerWolf\"\n        date_created = \"2023-02-23\"\n        date_last_modified = \"2023-02-23\"\n        description = \"Looks for OneNote Files with known malicious strings\"\n\n    strings:\n\t\t$start = { e4 52 5c 7b 8c d8 a7 4d ae b1 53 78 d0 29 96 d3 } //beginning of a OneNote file\n\t\t\n\t\t//Start of malicious strings\n\t\t$hex_string1 = { 5a 00 3a 00 5c 00 62 00 75 00 69 00 6c 00 64 00 65 00 72 00 5c } // Z:\\builder\\\n\t\t$hex_string2 = { 5a 00 3a 00 5c 00 62 00 75 00 69 00 6c 00 64 00 5c } // Z:\\build\\\n\t\t\n    condition:\n        $start at 0 and ($hex_string1 or $hex_string2)\n}\n\nrule OneNote_BuildPath\n{\n    meta:\n        id = \"6lPn0V5wZyc2iuEz13uKAZ\"\n        fingerprint = \"f8ed9e3cdd5411e2bda7495c8b00b8e69e8f495db97cf542f6a1f3b790bef7a5\"\n        version = \"1.0\"\n        first_imported = \"2023-02-02\"\n        last_modified = \"2023-02-23\"\n        status = \"RELEASED\"\n        sharing = \"TLP:WHITE\"\n        source = \"BARTBLAZE\"\n        author = \"@bartblaze\"\n        description = \"Identifies malicious OneNote file by build path.\"\n        category = \"MALWARE\"\n\nstrings:\n\t//Z:\\build\\one\\attachment.hta\n\t$path_0 = {5a003a005c006200750069006c0064005c006f006e0065005c006100740074006100630068006d0065006e0074002e00680074006100}\n\t//Z:\\builder\\O P E N.wsf\n\t$path_1 = {5a003a005c006200750069006c006400650072005c004f00200050002000450020004e002e00770073006600}\ncondition:\n\tfilesize <200KB and any of them\n}",
    "uploadedBy": "f0b33c9c-0019-4046-984b-f6f3d95dea61",
    "category": "yar",
    "uploadedAt": "2025-05-07T09:54:43.603Z",
    "status": "active"
}